# Configuration Supabase pour la v√©rification d'email

Ce document explique comment configurer Supabase pour que le syst√®me de v√©rification d'email fonctionne correctement.

## 1. Configuration de l'authentification

Allez sur votre projet Supabase : https://trzjwipxrftkdhvyzmbi.supabase.co

### √âtape 1 : Activer la v√©rification d'email

1. Allez dans **Authentication** ‚Üí **Providers** ‚Üí **Email**
2. Activez les options suivantes :
   - ‚úÖ **Enable email provider**
   - ‚úÖ **Enable email confirmations** (IMPORTANT !)
   - ‚ùå **Disable** "Enable anonymous sign-ins" (optionnel)

### √âtape 2 : Configurer les URLs de redirection

1. Allez dans **Authentication** ‚Üí **URL Configuration**
2. Configurez les URLs suivantes :

#### Site URL
```
https://time-sheet-j6k9.vercel.app
```
> ‚ö†Ô∏è **Important** : Utilisez votre URL de production, PAS localhost !

#### Redirect URLs
Ajoutez les URLs autoris√©es pour les redirections apr√®s v√©rification d'email :
```
https://time-sheet-j6k9.vercel.app/**
https://time-sheet-j6k9.vercel.app/auth/callback
```

Si vous voulez tester en local pour le d√©veloppement, ajoutez aussi :
```
http://localhost:5173/**
http://localhost:5173/auth/callback
```

### √âtape 3 : Personnaliser l'email de v√©rification

1. Allez dans **Authentication** ‚Üí **Email Templates**
2. S√©lectionnez **"Confirm signup"**
3. Personnalisez le template email si n√©cessaire

**Template par d√©faut** :
```html
<h2>Confirmez votre inscription</h2>

<p>Suivez ce lien pour confirmer votre email :</p>
<p><a href="{{ .ConfirmationURL }}">Confirmer mon email</a></p>
```

> üí° **Note** : Le lien `{{ .ConfirmationURL }}` redirigera automatiquement vers votre Site URL configur√© √† l'√©tape 2.

### √âtape 4 : Configuration SMTP (Optionnel mais recommand√© pour production)

Par d√©faut, Supabase utilise son service d'envoi d'emails, mais il est limit√©. Pour la production, configurez votre propre SMTP :

1. Allez dans **Settings** ‚Üí **Auth** ‚Üí **SMTP Settings**
2. Activez **"Enable Custom SMTP"**
3. Configurez avec votre service (Gmail, SendGrid, AWS SES, etc.)

**Exemple avec Gmail** :
- Host : `smtp.gmail.com`
- Port : `587`
- Username : `votre-email@gmail.com`
- Password : Utilisez un [App Password](https://support.google.com/accounts/answer/185833)

## 2. Configuration de la base de donn√©es

### Cr√©er la table timesheets

‚úÖ **D√âJ√Ä FAIT** - Votre table est d√©j√† cr√©√©e avec cette structure :

```sql
CREATE TABLE timesheets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users NOT NULL,
    week_start_date DATE NOT NULL,
    grid_data JSONB NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE(user_id, week_start_date)
);
```

**Il faut maintenant ajouter les politiques RLS (Row Level Security) :**

```sql
-- Activer RLS (Row Level Security)
ALTER TABLE timesheets ENABLE ROW LEVEL SECURITY;

-- Politique : Les utilisateurs peuvent voir leurs propres donn√©es
CREATE POLICY "Users can view own timesheets"
    ON timesheets FOR SELECT
    USING (auth.uid() = user_id);

-- Politique : Les utilisateurs peuvent ins√©rer leurs propres donn√©es
CREATE POLICY "Users can insert own timesheets"
    ON timesheets FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- Politique : Les utilisateurs peuvent mettre √† jour leurs propres donn√©es
CREATE POLICY "Users can update own timesheets"
    ON timesheets FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

-- Politique : Les utilisateurs peuvent supprimer leurs propres donn√©es
CREATE POLICY "Users can delete own timesheets"
    ON timesheets FOR DELETE
    USING (auth.uid() = user_id);

-- Index pour performance (optionnel mais recommand√©)
CREATE INDEX IF NOT EXISTS idx_timesheets_user_id ON timesheets(user_id);
CREATE INDEX IF NOT EXISTS idx_timesheets_week_start_date ON timesheets(week_start_date);
```

## 3. Param√®tres de s√©curit√© suppl√©mentaires

### D√©sactiver les inscriptions non v√©rifi√©es

Pour emp√™cher les utilisateurs de se connecter AVANT d'avoir v√©rifi√© leur email :

1. Allez dans **Authentication** ‚Üí **Providers** ‚Üí **Email**
2. **D√©sactivez** "Allow users to sign in without email confirmation"

> ‚ö†Ô∏è Cette option est CRUCIALE pour la s√©curit√© !

### Configuration du temps d'expiration des tokens

1. Allez dans **Settings** ‚Üí **Auth**
2. Configurez :
   - **JWT expiry limit** : `3600` (1 heure)
   - **Email confirmation token expiry** : `86400` (24 heures)

## 4. Test de la configuration

### Test en d√©veloppement local

1. D√©marrez votre application : `npm run dev`
2. Allez sur http://localhost:5173
3. Cr√©ez un nouveau compte
4. V√©rifiez votre email (inbox ou spam)
5. Cliquez sur le lien de confirmation
6. Vous devriez √™tre redirig√© vers l'application avec un message de succ√®s

### Test en production

1. D√©ployez votre application sur votre domaine
2. R√©p√©tez les √©tapes ci-dessus
3. Le lien de v√©rification devrait pointer vers votre domaine de production

## 5. D√©pannage

### ‚ùå "Email not confirmed" au login
**Solution** : L'utilisateur doit d'abord cliquer sur le lien dans l'email de v√©rification.

### ‚ùå Le lien de v√©rification redirige vers la mauvaise URL
**Solution** : V√©rifiez le **Site URL** dans les param√®tres Supabase.

### ‚ùå L'email de v√©rification n'arrive pas
**Solutions** :
- V√©rifiez les spams
- V√©rifiez que "Enable email confirmations" est activ√©
- Configurez un SMTP custom pour la production
- V√©rifiez les logs dans **Authentication** ‚Üí **Logs**

### ‚ùå "Invalid redirect URL"
**Solution** : Ajoutez l'URL dans **Redirect URLs** dans les param√®tres Supabase.

### ‚ùå Erreur "rate limit exceeded"
**Solution** : Supabase limite l'envoi d'emails. Attendez quelques minutes ou configurez un SMTP custom.

## 6. Variables d'environnement

Cr√©ez un fichier `.env` √† la racine du projet (ne jamais commit ce fichier !) :

```env
VITE_SUPABASE_URL=https://trzjwipxrftkdhvyzmbi.supabase.co
VITE_SUPABASE_ANON_KEY=votre-cle-anon-key-ici
```

> üí° Un fichier `.env.example` est fourni comme r√©f√©rence.

## 7. D√©ploiement

Lors du d√©ploiement sur Vercel, Netlify, ou autre :

1. Ajoutez les variables d'environnement dans les param√®tres du service
2. Mettez √† jour le **Site URL** dans Supabase avec votre URL de production
3. Ajoutez l'URL de production dans **Redirect URLs**

---

## R√©sum√© de la configuration minimale

‚úÖ **Authentication** ‚Üí **Providers** ‚Üí **Email** ‚Üí "Enable email confirmations"
‚úÖ **Authentication** ‚Üí **URL Configuration** ‚Üí **Site URL** = `https://time-sheet-j6k9.vercel.app`
‚úÖ **Authentication** ‚Üí **URL Configuration** ‚Üí **Redirect URLs** = `https://time-sheet-j6k9.vercel.app/**`
‚úÖ Ajouter les politiques RLS √† la table `timesheets`
‚úÖ D√©sactiver "Allow users to sign in without email confirmation"

---

**Besoin d'aide ?**
- [Documentation Supabase Auth](https://supabase.com/docs/guides/auth)
- [Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Configuration SMTP](https://supabase.com/docs/guides/auth/auth-smtp)
